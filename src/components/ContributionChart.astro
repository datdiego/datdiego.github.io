---
const username = "datdiego";

type Day = { date: string; count: number; isFuture: boolean };

let weeks: Day[][] = [];
let totalContributions = 0;
let dataAvailable = false;

// Build the date grid: 53 weeks ending at the end of the current week
const today = new Date();
today.setHours(0, 0, 0, 0);

// Start from the Sunday that is 52 full weeks before this week's Sunday
const thisWeekSunday = new Date(today);
thisWeekSunday.setDate(today.getDate() - today.getDay());

const gridStart = new Date(thisWeekSunday);
gridStart.setDate(thisWeekSunday.getDate() - 52 * 7);

// Build empty grid
const tempWeeks: Day[][] = [];
const cursor = new Date(gridStart);
for (let w = 0; w < 53; w++) {
  const week: Day[] = [];
  for (let d = 0; d < 7; d++) {
    const dateStr = cursor.toISOString().split("T")[0];
    week.push({ date: dateStr, count: 0, isFuture: cursor > today });
    cursor.setDate(cursor.getDate() + 1);
  }
  tempWeeks.push(week);
}

// Fetch GitHub contribution data
const dayMap = new Map<string, number>();
try {
  const controller = new AbortController();
  const timeout = setTimeout(() => controller.abort(), 12000);
  const res = await fetch(
    `https://github.com/users/${username}/contributions`,
    {
      signal: controller.signal,
      headers: {
        "User-Agent": "datdiego-blog-build/3.0",
        Accept: "text/html,application/xhtml+xml",
      },
    }
  );
  clearTimeout(timeout);

  if (res.ok) {
    const html = await res.text();

    // Pattern A: SVG rect — data-count before data-date
    const patA =
      /data-count="(\d+)"[^>]{0,200}?data-date="(\d{4}-\d{2}-\d{2})"/g;
    // Pattern B: SVG rect — data-date before data-count
    const patB =
      /data-date="(\d{4}-\d{2}-\d{2})"[^>]{0,200}?data-count="(\d+)"/g;
    // Pattern C: table cell — data-date + data-level (0-4)
    const patC =
      /data-date="(\d{4}-\d{2}-\d{2})"[^>]{0,400}?data-level="(\d)"/gs;

    let m: RegExpExecArray | null;

    while ((m = patA.exec(html)) !== null) {
      dayMap.set(m[2], parseInt(m[1]));
    }
    while ((m = patB.exec(html)) !== null) {
      if (!dayMap.has(m[1])) dayMap.set(m[1], parseInt(m[2]));
    }

    // Fallback: level-based (0→0, 1→1, 2→4, 3→8, 4→12)
    if (dayMap.size === 0) {
      const LEVEL_COUNTS = [0, 1, 4, 8, 12];
      while ((m = patC.exec(html)) !== null) {
        const level = Math.min(parseInt(m[2]), 4);
        dayMap.set(m[1], LEVEL_COUNTS[level]);
      }
    }
  }

  if (dayMap.size > 0) {
    dataAvailable = true;
    for (const count of dayMap.values()) totalContributions += count;
  }
} catch {
  // build continues with zero data — grid renders empty
}

// Apply counts to grid
for (const week of tempWeeks) {
  for (const day of week) {
    if (!day.isFuture && dayMap.has(day.date)) {
      day.count = dayMap.get(day.date)!;
    }
  }
}
weeks = tempWeeks;

// Month labels: emit label at first week that starts a new month
const MONTH_NAMES = [
  "Jan","Feb","Mar","Apr","May","Jun",
  "Jul","Aug","Sep","Oct","Nov","Dec",
];
const monthLabels: { label: string; colIndex: number }[] = [];
let lastMonth = -1;
weeks.forEach((week, wi) => {
  const m = new Date(week[0].date + "T12:00:00Z").getUTCMonth();
  if (m !== lastMonth) {
    monthLabels.push({ label: MONTH_NAMES[m], colIndex: wi });
    lastMonth = m;
  }
});

function levelClass(count: number, isFuture: boolean): string {
  if (isFuture) return "day-future";
  if (count === 0) return "day-l0";
  if (count <= 3) return "day-l1";
  if (count <= 6) return "day-l2";
  if (count <= 9) return "day-l3";
  return "day-l4";
}
---

<section id="contribution-chart" class="pt-12 pb-6 border-t border-border">
  <div class="chart-header">
    <h2 class="text-2xl font-semibold tracking-wide">Activity</h2>
    {dataAvailable && (
      <span class="chart-total">
        {totalContributions.toLocaleString()} contributions in the last year
      </span>
    )}
  </div>

  <div class="chart-scroll-wrap">
    <div class="chart-inner">

      <!-- Month labels row -->
      <div class="chart-grid-row">
        <div class="day-label-spacer" />
        <div class="months-grid">
          {monthLabels.map(({ label, colIndex }) => (
            <span
              class="month-label"
              style={`grid-column-start: ${colIndex + 1}`}
            >
              {label}
            </span>
          ))}
        </div>
      </div>

      <!-- Day labels + weeks grid -->
      <div class="chart-grid-row chart-grid-row--main">
        <div class="day-labels">
          <span></span>
          <span>Mon</span>
          <span></span>
          <span>Wed</span>
          <span></span>
          <span>Fri</span>
          <span></span>
        </div>

        <div class="weeks-grid">
          {weeks.map(week => (
            <div class="week-col">
              {week.map(day => (
                <div
                  class={`day-cell ${levelClass(day.count, day.isFuture)}`}
                  title={
                    day.isFuture
                      ? ""
                      : `${day.date}: ${day.count} contribution${day.count !== 1 ? "s" : ""}`
                  }
                />
              ))}
            </div>
          ))}
        </div>
      </div>

      <!-- Legend -->
      <div class="chart-legend">
        <span class="legend-text">Less</span>
        <div class="day-cell day-l0" />
        <div class="day-cell day-l1" />
        <div class="day-cell day-l2" />
        <div class="day-cell day-l3" />
        <div class="day-cell day-l4" />
        <span class="legend-text">More</span>
      </div>

    </div>
  </div>
</section>

<style>
  /* ── Layout ─────────────────────────────────────────── */
  .chart-header {
    display: flex;
    align-items: baseline;
    gap: 1rem;
    flex-wrap: wrap;
    margin-bottom: 0.75rem;
  }

  .chart-total {
    font-size: 0.8rem;
    color: var(--foreground);
    opacity: 0.55;
  }

  .chart-scroll-wrap {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 0.25rem;
  }

  .chart-inner {
    display: inline-flex;
    flex-direction: column;
    gap: 3px;
    min-width: max-content;
  }

  /* Shared row: day-label-spacer + grid */
  .chart-grid-row {
    display: flex;
    align-items: flex-end;
    gap: 4px;
  }

  .chart-grid-row--main {
    align-items: flex-start;
  }

  .day-label-spacer {
    width: 28px;
    flex-shrink: 0;
  }

  /* ── Month labels ────────────────────────────────────── */
  .months-grid {
    display: grid;
    grid-template-columns: repeat(53, 11px);
    gap: 2px;
    overflow: visible;
  }

  .month-label {
    font-size: 0.6rem;
    color: var(--foreground);
    opacity: 0.45;
    white-space: nowrap;
    overflow: visible;
    line-height: 1.2;
  }

  /* ── Day labels (left side) ──────────────────────────── */
  .day-labels {
    display: grid;
    grid-template-rows: repeat(7, 11px);
    gap: 2px;
    width: 28px;
    flex-shrink: 0;
  }

  .day-labels span {
    font-size: 0.58rem;
    color: var(--foreground);
    opacity: 0.4;
    display: flex;
    align-items: center;
    line-height: 1;
  }

  /* ── Weeks grid ──────────────────────────────────────── */
  .weeks-grid {
    display: grid;
    grid-template-columns: repeat(53, 11px);
    gap: 2px;
  }

  .week-col {
    display: grid;
    grid-template-rows: repeat(7, 11px);
    gap: 2px;
  }

  /* ── Day cells ───────────────────────────────────────── */
  .day-cell {
    width: 11px;
    height: 11px;
    border-radius: 2px;
  }

  .day-l0 {
    background-color: var(--muted);
    outline: 1px solid var(--border);
    outline-offset: -1px;
  }

  .day-l1 {
    background-color: color-mix(in srgb, var(--accent) 25%, var(--muted));
  }

  .day-l2 {
    background-color: color-mix(in srgb, var(--accent) 50%, var(--muted));
  }

  .day-l3 {
    background-color: color-mix(in srgb, var(--accent) 75%, var(--muted));
  }

  .day-l4 {
    background-color: var(--accent);
  }

  .day-future {
    background-color: transparent;
  }

  /* ── Legend ──────────────────────────────────────────── */
  .chart-legend {
    display: flex;
    align-items: center;
    gap: 3px;
    margin-top: 4px;
    justify-content: flex-end;
  }

  .legend-text {
    font-size: 0.6rem;
    color: var(--foreground);
    opacity: 0.45;
    margin: 0 2px;
  }
</style>
